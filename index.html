const SPREADSHEET_ID = '1ML7kfYA2q79rNebYYK8wnMvnSxaD-1kaKaIqqPotcUs';
const SHEET_NAME = 'Лист1';

function doGet(e) {
  // Выдаём HTML страницу
  return HtmlService.createHtmlOutputFromFile('index');
}

function doPost(e) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);

  // Если отправка брони
  if(e.parameter.action === 'book') {
    const name = e.parameter.name || '';
    const car = e.parameter.car || '';
    const radius = e.parameter.radius || '';
    const service = e.parameter.service || '';
    const date = e.parameter.date || '';
    const time = e.parameter.time || '';

    // Проверяем, есть ли запись на это время
    const data = sheet.getDataRange().getValues();
    const conflict = data.find(row => row[4] === date && row[5] === time);
    if(conflict) {
      return ContentService.createTextOutput('ERROR: Время занято');
    }

    sheet.appendRow([new Date(), name, car, radius, date, time, service]);
    return ContentService.createTextOutput('OK');
  }

  return ContentService.createTextOutput('ERROR: Неверная операция');
}

// Получение будущих записей
function getBookings() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const now = new Date();
  const future = data.filter(row => new Date(row[4] + ' ' + row[5]) >= now);
  return future.map(r => ({
    name: r[1],
    car: r[2],
    radius: r[3],
    date: r[4],
    time: r[5],
    service: r[6]
  }));
}
